<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ì±—ë´‡</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* ğŸš¨ bodyì— ìƒë‹¨ë°” ë†’ì´ë§Œí¼ íŒ¨ë”©ì„ ì¶”ê°€í•˜ì—¬ ê²¹ì¹˜ëŠ” ë¬¸ì œ í•´ê²° */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            min-height: 100vh; /* ë·°í¬íŠ¸ ì „ì²´ ë†’ì´ë¥¼ í™•ë³´ */
        }

        .chat-wrapper {
            /* ì±—ë´‡ ì°½ì„ í˜ì´ì§€ ì¤‘ì•™ì— ë°°ì¹˜í•˜ëŠ” ì»¨í…Œì´ë„ˆ */
            display: flex;
            justify-content: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
            width: 100%;
            /* ë·°í¬íŠ¸ ë†’ì´ì—ì„œ bodyì˜ padding-topì„ ëº€ ê°’ìœ¼ë¡œ ì„¤ì • */
            min-height: calc(100vh - 60px);
        }

        #chat-window {
            /* ğŸš¨ ìˆ˜ì •: ì±—ë´‡ ì°½ í¬ê¸°ë¥¼ í™”ë©´ì— ë¹„ë¡€í•˜ì—¬ ì¡°ì • */
            width: 60vw;
            height: 70vh;
            max-width: 900px; /* ë°ìŠ¤í¬í†±ì—ì„œ ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒ ë°©ì§€ */
            min-height: 450px; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */

            border: 1px solid #ccc;
            background: white;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px auto; /* ìƒí•˜ ì—¬ë°± ì¶”ê°€í•˜ì—¬ ë·°í¬íŠ¸ ì¤‘ì•™ë³´ë‹¤ ì‚´ì§ ìœ„ë¡œ ë°°ì¹˜ */
        }
        #messages {
            flex-grow: 1;
            padding: 15px; /* íŒ¨ë”© ì¦ê°€ */
            overflow-y: auto;
            word-wrap: break-word;
        }
        #input-area {
            display: flex;
            padding: 15px; /* íŒ¨ë”© ì¦ê°€ */
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
        }
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px; /* í°íŠ¸ í¬ê¸° ì¦ê°€ */
        }
        #send-button {
            padding: 10px 20px; /* ë²„íŠ¼ í¬ê¸° ì¦ê°€ */
            margin-left: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #send-button:hover {
            background-color: #0056b3;
        }
        .message {
            margin-bottom: 15px; /* ë©”ì‹œì§€ ê°„ ê°„ê²© ì¦ê°€ */
            padding: 10px 15px; /* ë©”ì‹œì§€ ë‚´ë¶€ íŒ¨ë”© ì¦ê°€ */
            border-radius: 18px;
            max-width: 80%;
        }
        .user {
            margin-left: auto;
            text-align: right;
            background-color: #d1e7ff;
            border-bottom-right-radius: 2px;
        }
        .bot {
            margin-right: auto;
            text-align: left;
            background-color: #e2e3e5;
            border-bottom-left-radius: 2px;
        }
    </style>
</head>
<body>
    <nav class="top-bar">
        <div class="navbar_name">
            <a href="/">S.J.D.J</a>
        </div>

        <ul class="navbar_list">
            <li><a href="/about">ì‹¤ì¦ë‹¨ì§€ ì†Œê°œ</a></li>
            <li><a href="/datas">ì˜¨ì‹¤ 3D ëª¨ë¸ë§</a></li>
            <li><a href="/participate">ì‹¤ì‹œê°„ ë°ì´í„°</a></li>
            <li><a href="/sns">ì˜ê²¬ ê²Œì‹œíŒ</a></li>
            <li><a href="/aichat">AI ì±—ë´‡</a></li>
        </ul>

        <ul class="user-info">
            {% if user %}
                {{ user.username }} ({{ user.role }}) ë‹˜ ë¡œê·¸ì¸ë¨ |
                <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
            {% else %}
                <a href="/login">ë¡œê·¸ì¸</a> /
                <a href="/register">íšŒì›ê°€ì…</a>
            {% endif %}
        </ul>
    </nav>

    <div class="chat-wrapper">
        <div id="chat-window">
            <div id="messages">
                <!-- ë©”ì‹œì§€ëŠ” JSì—ì„œ ì²˜ë¦¬ -->
            </div>
            <div id="input-area">
                <input type="text" id="user-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="send-button">ì „ì†¡</button>
            </div>
        </div>
    </div>


    <script>
        const inputElement = document.getElementById('user-input');
        const messagesDiv = document.getElementById('messages');

        document.getElementById('send-button').addEventListener('click', () => handleManualSend());
        inputElement.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleManualSend();
            }
        });

        // ìˆ˜ë™ ì „ì†¡ í•¸ë“¤ëŸ¬: ì…ë ¥ì°½ ê°’ ì‚¬ìš© ë° ì…ë ¥ì°½ ë¹„ìš°ê¸° ì²˜ë¦¬
        function handleManualSend() {
            const message = inputElement.value.trim();
            if (message) {
                // ì…ë ¥ì°½ì„ ë¹„ìš°ëŠ” ë¡œì§ì„ ì—¬ê¸°ì—ë§Œ ë‘ 
                inputElement.value = '';
                sendMessage(message);
            }
        }

        // ë©”ì‹œì§€ë¥¼ ì¸ìˆ˜ë¡œ ë°›ì•„ ì²˜ë¦¬
        function sendMessage(message) {
            const msgToSend = message;

            if (!msgToSend) return;

            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.textContent = msgToSend;
            messagesDiv.appendChild(userMsg);

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // ì±—ë´‡ ì‘ë‹µ ëŒ€ê¸° ë©”ì‹œì§€
            const botThinking = document.createElement('div');
            botThinking.className = 'message bot';
            botThinking.textContent = '...ë‹µë³€ì„ ìƒê° ì¤‘ì…ë‹ˆë‹¤...';
            messagesDiv.appendChild(botThinking);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;


            // FastAPI APIë¡œ ë©”ì‹œì§€ ì „ì†¡
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: msgToSend }),
            })
            .then(response => {
                if (!response.ok) {
                    // HTTP ì˜¤ë¥˜ ìƒíƒœ ì½”ë“œ ì²˜ë¦¬ (ì˜ˆ: 500 Internal Server Error)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ëŒ€ê¸° ë©”ì‹œì§€ ì œê±°
                messagesDiv.removeChild(botThinking);

                const botMsg = document.createElement('div');
                botMsg.className = 'message bot';

                // --- URL ìë™ ê°ì§€ ë° ë§í¬ ë³€í™˜ ë¡œì§ ---
                const botResponseText = data.response;

                // URLì„ ê°ì§€í•˜ì—¬ <a> íƒœê·¸ë¡œ ë³€í™˜í•˜ëŠ” ì •ê·œ í‘œí˜„ì‹
                const urlRegex = /(https?:\/\/[^\s]+)/g;

                // í…ìŠ¤íŠ¸ë¥¼ HTML í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ innerHTMLì— í• ë‹¹
                botMsg.innerHTML = botResponseText.replace(urlRegex, function(url) {
                    return '<a href="' + url + '" target="_blank" style="color:#007bff; text-decoration:underline; font-weight:bold;">' + url + '</a>';
                });
                // ------------------------------------

                messagesDiv.appendChild(botMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                messagesDiv.removeChild(botThinking);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'message bot';
                errorMsg.textContent = `í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì±—ë´‡ ì´ˆê¸°í™” ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (${error.message})`;
                messagesDiv.appendChild(errorMsg);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        }

        // ğŸš¨ í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë˜ëŠ” ìë™ ì‘ë‹µ ë¡œì§
        document.addEventListener('DOMContentLoaded', function() {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ 'query' ê°’ ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const initialQuery = urlParams.get('query');

            // ì›°ì»´ ë©”ì‹œì§€ ì¶”ê°€ (ìë™ ìš”ì²­ì´ ì—†ì„ ë•Œë§Œ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ)
            if (!initialQuery) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message bot';
                welcomeMsg.textContent = 'ì•ˆë…•í•˜ì„¸ìš”! ì›¹ì‚¬ì´íŠ¸ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ë‚˜, ê°€ê³  ì‹¶ì€ í˜ì´ì§€ë¥¼ ë§ì”€í•´ì£¼ì„¸ìš”.';
                messagesDiv.appendChild(welcomeMsg);
            }

            if (initialQuery) {
                // queryê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘
                sendMessage(initialQuery);
            }
        });
    </script>
</body>
</html>