<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>í™ˆ - ì‹¤ì¦ë‹¨ì§€</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/news_style.css">
    <link rel="stylesheet" href="/static/profile.css">
    <!-- main_parallax.cssëŠ” ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ê°€ ìˆìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
    <link rel="stylesheet" href="/static/main_parallax.css">

    <style>
        /* ğŸš¨ ìˆ˜ì •: ì „ì²´ ì½˜í…ì¸  ì˜ì—­ì˜ ë„ˆë¹„ë¥¼ 1200pxë¡œ ì œí•œí•˜ê³  ì¤‘ì•™ ì •ë ¬ */
        :root {
            /* ë©”ì¸ ì½˜í…ì¸ ì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ 1200pxë¡œ ê³ ì •í•˜ì—¬ ê¹”ë”í•œ ì—¬ë°± í™•ë³´ */
            --main-content-max-width: 1200px;
            /* --chat-box-width: 600px; ë³€ìˆ˜ëŠ” ì œê±° */
        }

        /* ğŸš¨ ì¤‘ìš”: main-section, chatbox-sectionì— ê³ ì •ëœ max-widthì™€ margin: auto ì ìš© */
        .chatbox-section, .main-section, .ipju-section { /* ğŸš¨ ipju-section ì¶”ê°€ */
            max-width: var(--main-content-max-width); /* 1200pxë¡œ ì œí•œ */
            width: 100%;
            margin-left: auto; /* ì¤‘ì•™ ì •ë ¬ */
            margin-right: auto;

            /* ì¢Œìš°ì— 20pxì˜ ë‚´ë¶€ íŒ¨ë”©ì„ ì¶”ê°€í•˜ì—¬ ë‚´ìš©ì´ ëì— ë¶™ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. */
            padding: 0 20px;
            box-sizing: border-box;
        }

        .chatbox-section {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ğŸš¨ ipju ì„¹ì…˜ ìŠ¤íƒ€ì¼ (ì¹´ë“œ ë””ìì¸ ì ìš©) */
        .ipju-section {
            margin-top: 40px;
            margin-bottom: 40px;
            padding: 25px 30px;
            background: #eaf6e5; /* ì—°í•œ ë…¹ìƒ‰ ë°°ê²½ */
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .ipju-section h2 {
            color: #008000;
            margin-bottom: 15px;
            border-bottom: none;
        }
        .ipju-section a.ipju-link {
            display: inline-block;
            padding: 10px 25px;
            margin-top: 15px;
            background-color: #008000;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .ipju-section a.ipju-link:hover {
            background-color: #b4cd13;
        }


        .chatbox {
            /* ğŸš¨ ìˆ˜ì •: ì§ˆë¬¸ ì…ë ¥ì°½ ë„ˆë¹„ë¥¼ ë¶€ëª¨ ì»¨í…Œì´ë„ˆ(1200px)ì™€ ë™ì¼í•˜ê²Œ 100%ë¡œ í™•ì¥ */
            width: 100%;
            max-width: var(--main-content-max-width); /* 1200pxì— ë§ì¶¥ë‹ˆë‹¤. */
        }

        #chatResponse {
            width: 100%;

            /* ë†’ì´ ì¦ê°€ ë° ê°€ë…ì„± í™•ë³´ */
            min-height: 150px;
            max-height: 400px;

            /* ë””ìì¸ */
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);

            padding: 20px;
            margin-top: 20px;
            overflow-y: auto;

            /* ğŸš¨ ì¤‘ìš” ìˆ˜ì •: ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ ìƒíƒœë¡œ ì„¤ì • */
            display: none;

            /* main_parallax.cssì˜ ì• ë‹ˆë©”ì´ì…˜ ì†ì„±ì„ ê°•ì œë¡œ ë®ì–´ì”ë‹ˆë‹¤. */
            opacity: 1 !important;
            transform: none !important;
            transition: none !important;
        }

        /* ì±—ë´‡ ë‹µë³€ í…ìŠ¤íŠ¸ ê°€ë…ì„±ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        #chatResponse p {
            font-size: 1.1em;
        }
        .user-query {
            font-weight: bold;
            color: #007acc;
            margin-bottom: 10px;
            border-bottom: 2px solid #b4cd13;
            padding-bottom: 5px;
        }
        .bot-response {
            margin-top: 10px;
            font-size: 1.1em;
            white-space: pre-wrap;
        }
        .loading-indicator {
            color: #888;
            font-style: italic;
        }
    </style>
</head>

<body>
    <nav class="top-bar">
        <div class="navbar_name">
            <a href="/">S.J.D.J</a>
        </div>

        <ul class="navbar_list">
            <li><a href="/about">ì‹¤ì¦ë‹¨ì§€ ì†Œê°œ</a></li>
            <li><a href="/datas">ì˜¨ì‹¤ 3D ëª¨ë¸ë§</a></li>
            <li><a href="/participate">ì‹¤ì‹œê°„ ë°ì´í„°</a></li>
            <li><a href="/sns">ì˜ê²¬ ê²Œì‹œíŒ</a></li>
            <li><a href="/aichat">AI ì±—ë´‡</a></li>
        </ul>

        <ul class="user-info">
            {% if user %}
                {{ user.username }} ({{ user.role }}) ë‹˜ ë¡œê·¸ì¸ë¨ |
                <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
            {% else %}
                <a href="/login">ë¡œê·¸ì¸</a> /
                <a href="/register">íšŒì›ê°€ì…</a>
            {% endif %}
        </ul>
    </nav>

    <section class="hero-image-section">
        <h1>ê¹€ì œ ìŠ¤ë§ˆíŠ¸íŒœ í˜ì‹ ë°¸ë¦¬ ì‹¤ì¦ë‹¨ì§€</h1>
        <p>ë¯¸ë˜ ë†ì—…ì˜ ì‹œì‘, ê¹€ì œì—ì„œ í™•ì¸í•˜ì„¸ìš”</p>
    </section>

    <!-- ì±—ë´‡ ì„¹ì…˜ -->
    <section class="chatbox-section">
      <div class="chatbox">
        <h2>ì±—ë´‡ ì„œë¹„ìŠ¤</h2>
        <input id="chatInput" type="text" placeholder="ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? (ì˜ˆ: ì›¹ì‚¬ì´íŠ¸ ì„¤ëª… ìš”ì²­)" />
        <button id="chatSend">ê²€ìƒ‰</button>
      </div>

      <!-- ì±—ë´‡ ì‘ë‹µì´ í‘œì‹œë  ì˜ì—­ (ì´ˆê¸° display: none) -->
      <div id="chatResponse" class="chat-response">
          <p>ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>
      </div>
    </section>

    <!-- ğŸš¨ ì¶”ê°€: ì…ì£¼ ì•ˆë‚´ ì»¨í…Œì´ë„ˆ -->
    <section class="ipju-section">
        <h2>ì„ëŒ€í˜• ìŠ¤ë§ˆíŠ¸íŒœ ì…ì£¼ ì•ˆë‚´</h2>
        <p>ì²­ë…„ ì°½ì—…ë†ì„ ìœ„í•œ ì „ë¬¸ ë³´ìœ¡ ê³¼ì •ê³¼ ì„ëŒ€í˜• ìŠ¤ë§ˆíŠ¸íŒœ ì…ì£¼ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”. ë¯¸ë˜ë¥¼ í•¨ê»˜í•  ì¸ì¬ë¥¼ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.</p>
        <a href="https://innovalley.smartfarmkorea.net/gimje/Demonstration/prv_application" class="ipju-link">ì…ì£¼ ìê²© ë° ì‹ ì²­ ë°”ë¡œê°€ê¸°</a>
    </section>
    <!-- ğŸš¨ ë: ì…ì£¼ ì•ˆë‚´ ì»¨í…Œì´ë„ˆ -->

    <!-- ë‰´ìŠ¤/ì§€ë„ ì„¹ì…˜ -->
    <section class="main-section">
        <div class="card news-card">
            <div class="card-header">
                <h2>ê¹€ì œ í˜ì‹ ë°¸ë¦¬ ê³µì§€/ë‰´ìŠ¤</h2>
                <p class="subtext">ê¹€ì œ ìŠ¤ë§ˆíŠ¸íŒœ í˜ì‹ ë°¸ë¦¬ ê³µì§€ì‚¬í•­</p>
            </div>

            <div class="news-container">
                {% for news in gimje_news[:3] %}
                <div class="news-item">
                    <div class="news-header">
                        <h3><a href="{{ news.link }}" target="_blank">{{ news.title }}</a></h3>
                        <p class="date">{{ news.date }}</p>
                    </div>
                </div>
                {% else %}
                <div class="news-item">
                    <p>í˜„ì¬ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆëŠ” ì™¸ë¶€ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
                {% endfor %}
            </div>

            <div class="card-footer">
                <a href="/news" class="btn-more">ë”ë³´ê¸° â†’</a>
            </div>
        </div>

        <div class="card map-card">
            <div class="card-header">
                <h2>ì‹¤ì¦ë‹¨ì§€ ìœ„ì¹˜ ì•ˆë‚´</h2>
                <p class="subtext">ìŠ¤ë§ˆíŠ¸íŒœ ì‹¤ì¦ë‹¨ì§€</p>
            </div>

            <div class="map-frame">
                <iframe
                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3232.685605925304!2d126.94999059999999!3d35.88122069999999!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x357047a26e92e5e1%3A0x2e5eb9fd4e287dc3!2z7KCE652867aB64-EIOq5gOygnCDsiqTrp4jtirjtjJwg7ZiB7Iug67C466as!5e0!3m2!1sko!2skr!4v1763452981065!5m2!1sko!2skr"
                    allowfullscreen=""
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">\
                </iframe>
            </div>
        </div>
    </section>

 <script>
  document.getElementById("chatSend").addEventListener("click", sendMessage);
  document.getElementById("chatInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
  });

  function sendMessage() {
    const inputElement = document.getElementById("chatInput");
    const responseDiv = document.getElementById("chatResponse");
    const msg = inputElement.value.trim();

    if (!msg) return;

    // ğŸš¨ ìˆ˜ì • 1: ì»¨í…Œì´ë„ˆ ë³´ì´ê²Œ ì„¤ì • (ì•„ë˜ ì½˜í…ì¸ ë¥¼ ë°€ì–´ëƒ…ë‹ˆë‹¤.)
    responseDiv.style.display = 'block';

    // ğŸš¨ ìˆ˜ì • 2: ì´ì „ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ê³  ìƒˆ ë‚´ìš©ìœ¼ë¡œ ì‹œì‘
    responseDiv.innerHTML = '';

    // ğŸš¨ ìƒˆ ì§ˆë¬¸ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•˜ì—¬ ë‹µë³€ì„ ë‹´ìŠµë‹ˆë‹¤.
    const newQueryContainer = document.createElement('div');
    newQueryContainer.className = 'query-container';

    // 1. ì‚¬ìš©ì ì§ˆë¬¸ í‘œì‹œ
    let content = `<p class="user-query">ì‚¬ìš©ì ì§ˆë¬¸: ${msg}</p>`;

    // 2. ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
    content += `<p id="botLoading" class="loading-indicator">ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p>`;

    newQueryContainer.innerHTML = content;
    responseDiv.prepend(newQueryContainer); // ê°€ì¥ ìœ„ì— ìƒˆ ì‘ë‹µ ì˜ì—­ ì¶”ê°€

    // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì´ë™
    responseDiv.scrollTop = 0;

    inputElement.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°


    // FastAPI APIë¡œ ë©”ì‹œì§€ ì „ì†¡
    fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg }),
    })
    .then(response => {
      if (!response.ok) {
        // ì„œë²„ ì¸¡ì—ì„œ 500 ì—ëŸ¬ ë“±ì´ ë°œìƒí•œ ê²½ìš°, ì‘ë‹µ ë³¸ë¬¸ì„ ì½ì–´ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸
        return response.json().then(errorData => {
             throw new Error(errorData.response || `HTTP error! status: ${response.status}`);
        }).catch(() => {
             // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, ì¼ë°˜ HTTP ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜
             throw new Error(`HTTP error! status: ${response.status}`);
        });
      }
      return response.json();
    })
    .then(data => {
      const loadingIndicator = newQueryContainer.querySelector('#botLoading');
      const botResponseText = data.response;

      // 3. ë¡œë”© ë©”ì‹œì§€ ì œê±°
      if (loadingIndicator) {
          loadingIndicator.remove();
      }

      // 4. URL ìë™ ê°ì§€ ë° ë§í¬ ë³€í™˜ ë¡œì§
      const urlRegex = /(https?:\/\/[^\s]+)/g;

      const botResponseHtml = botResponseText.replace(urlRegex, function(url) {
          return '<a href="' + url + '" target="_blank" style="color:#007bff; text-decoration:underline; font-weight:bold;">' + url + '</a>';
      });

      // 5. ì±—ë´‡ ì‘ë‹µ í‘œì‹œ
      newQueryContainer.innerHTML += `<div class="bot-response">${botResponseHtml}</div>`;

      // ìŠ¤í¬ë¡¤ ìµœì‹ í™” (ìƒˆ ë‹µë³€ì´ ìœ„ì— ì¶”ê°€ë˜ë¯€ë¡œ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤)
      responseDiv.scrollTop = 0;
    })
    .catch(error => {
      const loadingIndicator = newQueryContainer.querySelector('#botLoading');
      if (loadingIndicator) {
          loadingIndicator.remove();
      }
      // ğŸš¨ ì„œë²„ ì¸¡ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
      console.error("Error:", error);
      newQueryContainer.innerHTML += `<div class="bot-response" style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ì±—ë´‡ ì„œë²„ ì—°ê²° ì‹¤íŒ¨ ë˜ëŠ” ì´ˆê¸°í™” ë¬¸ì œ. (${error.message})</div>`;
    });
  }
 </script>

</body>
</html>